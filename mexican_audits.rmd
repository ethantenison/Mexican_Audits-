---
title: "Mexican Audits"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(stringr)
library(janitor)
library(magrittr)
library(reshape2)
```


```{r data}

data <- readRDS("mexican_audits.rds")

```

First extract the amount of pesos lost in each audit, and remove the values of that are NA. Second, add up the amount lost in each audit. Lastly, mutate this into a separate column to be used for data analysis.


```{r data cleaning}
data <- clean_names(data)
options("scipen"=100, "digits"=4)

df_con_extraccion <- data %>% dplyr::mutate(
  loss = stringr::str_extract_all(data$texto_accion, "[0-9,.]+(?= pesos)")
  ) %>%
  tidyr::unnest() %>%
  dplyr::mutate(
    loss =
      stringr::str_replace(loss, ",","") 
      )

df_con_extraccion$loss <- as.numeric(gsub(",", "", df_con_extraccion$loss, fixed = TRUE))
df_con_extraccion$loss[is.na(df_con_extraccion$loss)] <- 0
df_con_extraccion$clave_accion <- as.character(df_con_extraccion$clave_accion)
df_con_extraccion <- df_con_extraccion %>% group_by(clave_accion) %>% mutate(id = 1:n())

df_wide <- dcast(df_con_extraccion, clave_accion ~ id, value.var = "loss")
df_wide[is.na(df_wide)] <- 0
df_wide <- rename(df_wide, one = 2)
df_wide$check <- rowSums( df_wide[,3:27] )
for (i in 1:length(df_wide$one)){
           if(df_wide$one[i] == df_wide$check[i]){        
                    df_wide$one[i] <- 0              
           }
}
df_wide$total_loss <- rowSums( df_wide[,2:27])
loss_per_audit <- select(df_wide, clave_accion, total_loss)


data_with_loss <- left_join(data, loss_per_audit, by = "clave_accion")


saveRDS(data_with_loss,"mexican_audits_with_loss.rds")



```